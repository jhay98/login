name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
#   frontend-validate:
#     name: Frontend Validate
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '22'
#           cache: npm
#           cache-dependency-path: login-app/package-lock.json

#       - name: Install dependencies
#         working-directory: ./login-app
#         run: npm ci

#       - name: Run lint
#         working-directory: ./login-app
#         run: npm run lint

#       - name: Run frontend build
#         working-directory: ./login-app
#         run: npm run build

  backend-validate:
    name: Backend Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore
        run: dotnet restore ./login.sln

      - name: Build
        run: dotnet build ./login.sln --configuration Release --no-restore

      - name: Run backend tests
        run: dotnet test ./login.sln --configuration Release --no-build

  build-push-frontend:
    name: Build & Push Frontend
    runs-on: ubuntu-latest
    needs: [backend-validate]
    # needs: [frontend-validate, backend-validate]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u ${{ vars.DOCKER_HUB_USER }} --password-stdin

      - name: Build frontend image
        run: |
          docker build \
            -t ${{ vars.DOCKER_HUB_USER }}/${{ vars.DOCKER_HUB_REPO }}:${{ vars.DOCKER_HUB_FRONTEND_TAG }} \
            ./login-app

      - name: Push frontend image
        run: |
          docker push ${{ vars.DOCKER_HUB_USER }}/${{ vars.DOCKER_HUB_REPO }}:${{ vars.DOCKER_HUB_FRONTEND_TAG }}

  build-push-backend:
    name: Build & Push Backend
    runs-on: ubuntu-latest
    # needs: [frontend-validate, backend-validate]
    needs: [backend-validate]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u ${{ vars.DOCKER_HUB_USER }} --password-stdin

      - name: Build backend image
        run: |
          docker build \
            -t ${{ vars.DOCKER_HUB_USER }}/${{ vars.DOCKER_HUB_REPO }}:${{ vars.DOCKER_HUB_BACKEND_TAG }} \
            ./LoginAPI

      - name: Push backend image
        run: |
          docker push ${{ vars.DOCKER_HUB_USER }}/${{ vars.DOCKER_HUB_REPO }}:${{ vars.DOCKER_HUB_BACKEND_TAG }}

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [build-push-frontend, build-push-backend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy config files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ vars.SERVER_HOST }}
          username: ${{ vars.SERVER_USER }}
          port: ${{ vars.SERVER_PORT }}
          key: ${{ secrets.SSH_CERT }}
          source: "docker-compose.yml,nginx/nginx.conf"
          target: ${{ vars.PROJECT_DIR }}

      - name: SSH and redeploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ vars.SERVER_HOST }}
          username: ${{ vars.SERVER_USER }}
          port: ${{ vars.SERVER_PORT }}
          key: ${{ secrets.SSH_CERT }}
          script: |
            echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u ${{ vars.DOCKER_HUB_USER }} --password-stdin
            cd ${{ vars.PROJECT_DIR }}
            docker compose stop -t 1
            docker compose rm -f
            docker rmi ${{ vars.DOCKER_HUB_USER }}/${{ vars.DOCKER_HUB_REPO }}:${{ vars.DOCKER_HUB_FRONTEND_TAG }} || true
            docker rmi ${{ vars.DOCKER_HUB_USER }}/${{ vars.DOCKER_HUB_REPO }}:${{ vars.DOCKER_HUB_BACKEND_TAG }} || true
            docker compose pull frontend backend
            docker compose up -d postgres
            docker compose run --rm backend --migrate-only
            docker compose up -d frontend backend nginx
